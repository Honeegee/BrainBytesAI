# Grafana Cloud Agent Configuration for Heroku
# This config is optimized for Heroku's ephemeral filesystem and port restrictions

server:
  http_listen_port: ${PORT:-9090}
  grpc_listen_port: 0  # Disable gRPC server for Heroku

prometheus:
  global:
    scrape_interval: 30s
    evaluation_interval: 30s
    external_labels:
      environment: ${HEROKU_APP_NAME:-brainbytes}
      platform: "heroku"
      region: "us"

  configs:
  - name: heroku-brainbytes
    scrape_configs:
    # Self-scraping for agent metrics
    - job_name: 'grafana-agent'
      static_configs:
      - targets: ['localhost:${PORT:-9090}']
    
    # BrainBytes Backend Metrics
    - job_name: 'brainbytes-backend'
      scheme: https
      metrics_path: '/metrics'
      scrape_interval: 30s
      scrape_timeout: 10s
      static_configs:
      - targets:
        - 'brainbytes-backend-staging-de872da2939f.herokuapp.com'
        - 'brainbytes-backend-production-d355616d0f1f.herokuapp.com'
      relabel_configs:
      - source_labels: [__address__]
        regex: '.*staging.*'
        target_label: environment
        replacement: 'staging'
      - source_labels: [__address__]
        regex: '.*production.*'
        target_label: environment
        replacement: 'production'
    
    # BrainBytes AI Service Metrics  
    - job_name: 'brainbytes-ai-service'
      scheme: https
      metrics_path: '/metrics'
      scrape_interval: 30s
      scrape_timeout: 10s
      static_configs:
      - targets:
        - 'brainbytes-ai-service-staging-4b75c77cf53a.herokuapp.com'
        - 'brainbytes-ai-production-3833f742ba79.herokuapp.com'
      relabel_configs:
      - source_labels: [__address__]
        regex: '.*staging.*'
        target_label: environment
        replacement: 'staging'
      - source_labels: [__address__]
        regex: '.*production.*'
        target_label: environment
        replacement: 'production'

    remote_write:
    - url: ${GRAFANA_CLOUD_PROMETHEUS_URL}
      basic_auth:
        username: ${GRAFANA_CLOUD_PROMETHEUS_USER}
        password: ${GRAFANA_CLOUD_PROMETHEUS_PASSWORD}
      write_relabel_configs:
      - source_labels: [__name__]
        regex: 'brainbytes_.*'
        action: keep

logs:
  configs:
  - name: heroku-logs
    clients:
    - url: ${GRAFANA_CLOUD_LOKI_URL}
      basic_auth:
        username: ${GRAFANA_CLOUD_LOKI_USER}
        password: ${GRAFANA_CLOUD_LOKI_PASSWORD}
    
    positions:
      filename: /tmp/positions.yaml
    
    scrape_configs:
    - job_name: heroku-app-logs
      static_configs:
      - targets:
        - localhost
        labels:
          job: brainbytes
          __path__: /proc/1/fd/1  # Heroku stdout
      pipeline_stages:
      - regex:
          expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+\+\d{2}:\d{2}) (?P<source>\w+)\[(?P<proc>[^\]]+)\]: (?P<message>.*)'
      - labels:
          source:
          proc:
      - timestamp:
          source: timestamp
          format: RFC3339