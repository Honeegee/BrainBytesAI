# Heroku-specific Alert Rules for BrainBytesAI
# These rules are optimized for Heroku's platform constraints and BrainBytesAI's requirements

groups:
- name: brainbytes-heroku-critical
  rules:
  # Service availability alerts
  - alert: ServiceDown
    expr: up{job=~"brainbytes-.*"} == 0
    for: 2m
    labels:
      severity: critical
      service: "{{ $labels.job }}"
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "BrainBytesAI service is down"
      description: "Service {{ $labels.job }} in {{ $labels.environment }} has been down for more than 2 minutes"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#service-down"

  # Database connectivity
  - alert: DatabaseConnectionLost
    expr: brainbytes_db_connections_active == 0
    for: 1m
    labels:
      severity: critical
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "Database connection lost"
      description: "No active database connections in {{ $labels.environment }} environment"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#database-connection"

  # High error rate
  - alert: HighErrorRate
    expr: |
      (
        sum(rate(brainbytes_http_requests_total{status_code=~"5.."}[5m])) by (environment) /
        sum(rate(brainbytes_http_requests_total[5m])) by (environment)
      ) > 0.1
    for: 5m
    labels:
      severity: critical
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value | humanizePercentage }} in {{ $labels.environment }} environment"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#high-error-rate"

- name: brainbytes-heroku-warning
  rules:
  # High response time
  - alert: HighResponseTime
    expr: |
      histogram_quantile(0.95, 
        sum(rate(brainbytes_http_request_duration_seconds_bucket[5m])) by (le, environment)
      ) > 5
    for: 10m
    labels:
      severity: warning
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "High response time"
      description: "95th percentile response time is {{ $value }}s in {{ $labels.environment }}"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#high-response-time"

  # Slow AI responses
  - alert: SlowAIResponses
    expr: |
      histogram_quantile(0.95,
        sum(rate(brainbytes_ai_response_time_seconds_bucket[5m])) by (le, environment)
      ) > 10
    for: 5m
    labels:
      severity: warning
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "AI responses are slow"
      description: "95th percentile AI response time is {{ $value }}s in {{ $labels.environment }}"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#slow-ai-responses"

  # Memory usage warning (Heroku dyno limits)
  - alert: HighMemoryUsage
    expr: |
      (process_resident_memory_bytes / 1024 / 1024) > 400
    for: 15m
    labels:
      severity: warning
      environment: "{{ $labels.environment }}"
      job: "{{ $labels.job }}"
    annotations:
      summary: "High memory usage"
      description: "Memory usage is {{ $value }}MB on {{ $labels.job }} in {{ $labels.environment }}"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#high-memory-usage"

  # Low request rate (possible issues)
  - alert: LowRequestRate
    expr: |
      sum(rate(brainbytes_http_requests_total[10m])) by (environment) < 0.1
    for: 30m
    labels:
      severity: warning
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "Low request rate"
      description: "Request rate is {{ $value }} req/s in {{ $labels.environment }} - possible service issue"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#low-request-rate"

- name: brainbytes-heroku-info
  rules:
  # High tutoring session volume
  - alert: HighTutoringVolume
    expr: |
      increase(brainbytes_tutoring_sessions_total[1h]) > 100
    for: 0m
    labels:
      severity: info
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "High tutoring session volume"
      description: "{{ $value }} tutoring sessions in the last hour in {{ $labels.environment }}"

  # Connection drops (monitoring for Philippine network conditions)
  - alert: ConnectionDrops
    expr: |
      increase(brainbytes_connection_drops_total[1h]) > 10
    for: 0m
    labels:
      severity: info
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "Connection drops detected"
      description: "{{ $value }} connection drops in the last hour in {{ $labels.environment }}"

  # Mobile traffic spike
  - alert: MobileTrafficSpike
    expr: |
      increase(brainbytes_mobile_requests_total[1h]) > 500
    for: 0m
    labels:
      severity: info
      environment: "{{ $labels.environment }}"
    annotations:
      summary: "Mobile traffic spike"
      description: "{{ $value }} mobile requests in the last hour in {{ $labels.environment }}"

# Heroku-specific alerts for platform events
- name: brainbytes-heroku-platform
  rules:
  # Dyno restart detection (based on process uptime)
  - alert: DynoRestart
    expr: |
      increase(process_start_time_seconds[5m]) > 0
    for: 0m
    labels:
      severity: info
      environment: "{{ $labels.environment }}"
      job: "{{ $labels.job }}"
    annotations:
      summary: "Dyno restart detected"
      description: "Dyno {{ $labels.job }} restarted in {{ $labels.environment }}"

  # High CPU usage (Heroku CPU quota)
  - alert: HighCPUUsage
    expr: |
      rate(process_cpu_seconds_total[5m]) > 0.8
    for: 10m
    labels:
      severity: warning
      environment: "{{ $labels.environment }}"
      job: "{{ $labels.job }}"
    annotations:
      summary: "High CPU usage"
      description: "CPU usage is {{ $value | humanizePercentage }} on {{ $labels.job }} in {{ $labels.environment }}"
      runbook_url: "https://github.com/Honeegee/BrainBytesAI/wiki/Runbooks#high-cpu-usage"